<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRE-JUDGE MAP - 判断以前を整える</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <h1 class="title">PRE-JUDGE MAP</h1>
            <p class="subtitle">判断以前を整えて、判断をあなたに返します</p>
            
            <!-- ログイン/ユーザー情報 -->
            <div class="auth-section">
                <button id="btnGoogleLogin" class="btn-google-login" style="display: none;">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
                    Googleでログイン（履歴保存）
                </button>
                
                <div id="userInfo" class="user-info" style="display: none;"></div>
                
                <button id="btnViewHistory" class="btn-text" style="display: none;">📊 履歴を見る</button>
                <button id="btnLogout" class="btn-text" style="display: none;">ログアウト</button>
            </div>
        </header>

        <!-- 固定注意文 -->
        <div class="notice-banner">
            <div class="notice-content">
                <strong>当てません／決めません。</strong>判断以前を整えて、判断をあなたに返します。
            </div>
        </div>

        <!-- STEP 1: 同意とスタート -->
        <div id="step-consent" class="step active">
            <div class="card consent-card">
                <h2>ご利用前に</h2>
                <p class="description">
                    このツールは、あなたの迷いを「判断可能な状態」に整理し、<br>
                    <strong>地図（MAP）</strong>と<strong>指数（JUDGEX²）</strong>を提示します。<br>
                    助言や推奨は一切行いません。
                </p>
                
                <!-- ログインモード選択 -->
                <div class="login-mode-selection">
                    <h3>利用モードを選択</h3>
                    <div class="mode-options">
                        <label class="mode-option">
                            <input type="radio" name="loginMode" value="guest" checked>
                            <div class="mode-card">
                                <div class="mode-icon">🚶</div>
                                <div class="mode-title">ゲストモード</div>
                                <div class="mode-description">ログインなし・履歴保存なし</div>
                            </div>
                        </label>
                        
                        <label class="mode-option">
                            <input type="radio" name="loginMode" value="login">
                            <div class="mode-card">
                                <div class="mode-icon">📊</div>
                                <div class="mode-title">ログインモード</div>
                                <div class="mode-description">Googleログイン・履歴保存あり</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="consent-box">
                    <label class="consent-label">
                        <input type="checkbox" id="consentCheck" class="consent-checkbox">
                        <span class="consent-text">助言は求めず、地図と問いの提示のみを受け取ります</span>
                    </label>
                </div>

                <button id="btnStart" class="btn btn-primary" disabled>開始する</button>
            </div>
        </div>

        <!-- プログレスバー -->
        <div id="progress-container" class="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progressBar" class="progress-fill"></div>
            </div>
            <div class="progress-text">
                <span id="progressStep">ステップ 1</span> / 3
            </div>
        </div>

        <!-- STEP 2-1: Q1 迷いは何？ -->
        <div id="step-q1" class="step">
            <div class="card input-card">
                <div class="step-header">
                    <span class="step-badge">Q1</span>
                    <h2>迷いは何？</h2>
                </div>
                
                <p class="description">あなたが今、心の中で引っかかっていること、決めかねていることを教えてください。</p>

                <!-- よくあるパターン（選択式） -->
                <div class="preset-section">
                    <div class="preset-label">
                        <span>💡 よくあるパターンから選ぶ</span>
                        <button class="preset-toggle" id="togglePresetQ1">表示</button>
                    </div>
                    <div class="preset-options" id="presetQ1" style="display: none;">
                        <button class="preset-btn" data-text="転職すべきかどうか迷っている">💼 転職</button>
                        <button class="preset-btn" data-text="今の関係を続けるか別れるか迷っている">💔 人間関係</button>
                        <button class="preset-btn" data-text="独立・起業すべきか迷っている">🚀 独立・起業</button>
                        <button class="preset-btn" data-text="引っ越しや移住を考えているが決められない">🏠 引っ越し・移住</button>
                        <button class="preset-btn" data-text="大きな買い物（家・車など）をすべきか迷っている">💰 大きな買い物</button>
                        <button class="preset-btn" data-text="学校や仕事を辞めるか続けるか迷っている">📚 継続・退出</button>
                    </div>
                </div>

                <div class="question-group">
                    <textarea id="q1" class="question-input" rows="4" placeholder="例：営業職から企画職に転職するか迷っている。今の会社で5年働いているが、新しいことに挑戦したい気持ちと安定を失う不安がある。"></textarea>
                    <div class="input-footer">
                        <div class="char-counter" data-for="q1">
                            <span class="char-count">0</span> / 10文字以上推奨
                        </div>
                        <button class="example-btn" id="exampleQ1">📝 例文を見る</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btnQ1Next" class="btn btn-primary" disabled>次へ →</button>
                </div>
            </div>
        </div>

        <!-- STEP 2-2: Q2 選ばなければならないことは何？ -->
        <div id="step-q2" class="step">
            <div class="card input-card">
                <div class="step-header">
                    <span class="step-badge">Q2</span>
                    <h2>選ばなければならないことは何？</h2>
                </div>
                
                <p class="description">具体的な選択肢を明確にしてください。AかBか、やるかやらないか。</p>

                <!-- 前の回答の表示 -->
                <div class="previous-answer">
                    <div class="previous-label">Q1の回答</div>
                    <div id="q1Preview" class="previous-text"></div>
                </div>

                <div class="preset-section">
                    <div class="preset-label">
                        <span>💡 選択肢の形式を選ぶ</span>
                        <button class="preset-toggle" id="togglePresetQ2">表示</button>
                    </div>
                    <div class="preset-options" id="presetQ2" style="display: none;">
                        <button class="preset-btn" data-text="A（現状維持）か B（変化）か">⚖️ AかBか</button>
                        <button class="preset-btn" data-text="やるか、やらないか">✅ やる/やらない</button>
                        <button class="preset-btn" data-text="今すぐか、後でか、諦めるか">⏱️ タイミング</button>
                        <button class="preset-btn" data-text="複数の選択肢から1つを選ぶ">🎯 複数選択肢</button>
                    </div>
                </div>

                <div class="question-group">
                    <textarea id="q2" class="question-input" rows="4" placeholder="例：①今の会社で営業を続ける ②同業他社の企画職に転職する ③異業種の企画職に挑戦する"></textarea>
                    <div class="input-footer">
                        <div class="char-counter" data-for="q2">
                            <span class="char-count">0</span> / 10文字以上推奨
                        </div>
                        <button class="example-btn" id="exampleQ2">📝 例文を見る</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btnQ2Back" class="btn btn-secondary">← 戻る</button>
                    <button id="btnQ2Next" class="btn btn-primary" disabled>次へ →</button>
                </div>
            </div>
        </div>

        <!-- STEP 2-3: Q3 決めたら引き受けるものは何？ -->
        <div id="step-q3" class="step">
            <div class="card input-card">
                <div class="step-header">
                    <span class="step-badge">Q3</span>
                    <h2>決めたら引き受けるものは何？</h2>
                </div>
                
                <p class="description">決断の結果、あなたが背負うもの、失うもの、受け入れなければならないものは何ですか？</p>

                <!-- 前の回答の表示 -->
                <div class="previous-answer">
                    <div class="previous-label">Q1・Q2の回答</div>
                    <div id="q1q2Preview" class="previous-text"></div>
                </div>

                <div class="preset-section">
                    <div class="preset-label">
                        <span>💡 引き受けるものの種類</span>
                        <button class="preset-toggle" id="togglePresetQ3">表示</button>
                    </div>
                    <div class="preset-options" id="presetQ3" style="display: none;">
                        <button class="preset-btn" data-text="経済的なリスク（収入減、出費増など）">💸 経済的リスク</button>
                        <button class="preset-btn" data-text="人間関係の変化や喪失">👥 人間関係</button>
                        <button class="preset-btn" data-text="時間やキャリアの投資">⏳ 時間・キャリア</button>
                        <button class="preset-btn" data-text="安定や安心感を手放すこと">🛡️ 安定の喪失</button>
                        <button class="preset-btn" data-text="他の選択肢を諦めること（機会損失）">🚫 機会損失</button>
                        <button class="preset-btn" data-text="失敗した場合の責任や後悔">😰 失敗のリスク</button>
                    </div>
                </div>

                <div class="question-group">
                    <textarea id="q3" class="question-input" rows="4" placeholder="例：転職すると年収が100万円下がる可能性がある。営業の専門性を捨てることになる。失敗したら30代後半で再転職が難しくなる。"></textarea>
                    <div class="input-footer">
                        <div class="char-counter" data-for="q3">
                            <span class="char-count">0</span> / 10文字以上推奨
                        </div>
                        <button class="example-btn" id="exampleQ3">📝 例文を見る</button>
                    </div>
                </div>

                <div id="validationWarning" class="validation-warning" style="display: none;">
                    ⚠️ 一部の回答が短めです。地図の精度が下がる可能性があります。
                </div>

                <div class="action-buttons">
                    <button id="btnQ3Back" class="btn btn-secondary">← 戻る</button>
                    <button id="btnGenerateMap" class="btn btn-primary" disabled>MAPを生成（助言なし）</button>
                </div>
            </div>
        </div>

        <!-- STEP 3: MAP表示 -->
        <div id="step-map" class="step">
            <div class="card map-card">
                <h2>あなたのMAP</h2>
                
                <!-- デバッグ情報（開発用） -->
                <div id="debugInfo" style="background: #fff3cd; padding: 10px; margin-bottom: 20px; border-radius: 6px; font-size: 0.85rem; display: none;">
                    <strong>🐛 デバッグ情報:</strong>
                    <div>Layer: <span id="debugLayer"></span></div>
                    <div>ボタン状態: <span id="debugButton"></span></div>
                </div>
                
                <!-- Layer表示 -->
                <div class="layer-display">
                    <div class="layer-label">現在位置</div>
                    <div id="layerIndicator" class="layer-indicator">
                        <div class="layer-badge"></div>
                    </div>
                    <div id="layerDescription" class="layer-description"></div>
                </div>

                <!-- 詰まり点 -->
                <div class="map-section">
                    <h3 class="section-title">詰まり点</h3>
                    <div id="stuckPoints" class="stuck-points-list"></div>
                </div>

                <!-- 判断可能条件（問い） -->
                <div class="map-section">
                    <h3 class="section-title">判断可能条件（問い）</h3>
                    <div id="questions" class="questions-list"></div>
                </div>

                <div class="operator-message">
                    いまはこの位置です。決めるかどうかは、あなたが選んでください。
                </div>

                <!-- Layer別のアクション -->
                <div id="layerActions" class="layer-actions"></div>
            </div>
        </div>

        <!-- STEP 4: 追加入力（Layer1/2） -->
        <div id="step-followup" class="step">
            <div class="card followup-card">
                <!-- デバッグ情報（開発用） -->
                <div id="debugInfoFollowup" style="background: #fff3cd; padding: 10px; margin-bottom: 20px; border-radius: 6px; font-size: 0.85rem; display: none;">
                    <strong>🐛 フォローアップデバッグ:</strong>
                    <div>現在のLayer: <span id="debugCurrentLayer"></span></div>
                    <div>目標Layer: <span id="debugTargetLayer"></span></div>
                    <div>入力文字数: <span id="debugFollowupLength">0</span></div>
                </div>
                
                <h2 id="followupTitle"></h2>
                <p id="followupDescription" class="description"></p>

                <div class="question-group">
                    <textarea id="followupAnswer" class="question-input" rows="3" placeholder="例：本当は新しいことに挑戦したいが、失敗が怖い"></textarea>
                    <div class="input-footer">
                        <div class="char-counter" data-for="followupAnswer">
                            <span class="char-count">0</span> / 5文字以上必須
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btnSubmitFollowup" class="btn btn-primary" disabled>もう一度MAPを生成</button>
                </div>
            </div>
        </div>

        <!-- STEP 5: JUDGEX² -->
        <div id="step-judgex" class="step">
            <div class="card judgex-card">
                <h2>JUDGEX² 計測</h2>
                <div class="judgex-notice">
                    これは能力判定ではなく、今の傾向の計測です。
                </div>

                <div class="judgex-questions">
                    <!-- J1 -->
                    <div class="judgex-question">
                        <div class="judgex-q-title">J1. 決めた後、結果が悪かったときの扱いは？</div>
                        <div class="judgex-options">
                            <label class="judgex-option">
                                <input type="radio" name="j1" value="A">
                                <span>自分が引き受けて修正する</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j1" value="B">
                                <span>半分は状況、半分は自分</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j1" value="C">
                                <span>状況や他者のせいになりやすい</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j1" value="D">
                                <span>決定そのものをなかったことにしたくなる</span>
                            </label>
                        </div>
                    </div>

                    <!-- J2 -->
                    <div class="judgex-question">
                        <div class="judgex-q-title">J2. 期限が来たとき、あなたは何をする？</div>
                        <div class="judgex-options">
                            <label class="judgex-option">
                                <input type="radio" name="j2" value="A">
                                <span>不完全でも決めて動く</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j2" value="B">
                                <span>追加情報を集めてから決める</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j2" value="C">
                                <span>期限の解釈を変えて先延ばす</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j2" value="D">
                                <span>決めない理由を固める</span>
                            </label>
                        </div>
                    </div>

                    <!-- J3 -->
                    <div class="judgex-question">
                        <div class="judgex-q-title">J3. 「引き受けるもの（代償）」をどう扱う？</div>
                        <div class="judgex-options">
                            <label class="judgex-option">
                                <input type="radio" name="j3" value="A">
                                <span>最初に明文化してから決める</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j3" value="B">
                                <span>決めた後に調整しながら背負う</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j3" value="C">
                                <span>曖昧なまま進めて後で苦しくなる</span>
                            </label>
                            <label class="judgex-option">
                                <input type="radio" name="j3" value="D">
                                <span>見ないようにして決定を避ける</span>
                            </label>
                        </div>
                    </div>
                </div>

                <button id="btnCalculateJudgex" class="btn btn-primary" disabled>計測する</button>
            </div>
        </div>

        <!-- STEP 6: JUDGEX²結果 -->
        <div id="step-result" class="step">
            <div class="card result-card">
                <h2>計測結果</h2>
                
                <!-- 保存状態表示 -->
                <div id="saveStatus" class="save-status" style="display: none;">
                    <div id="saveStatusIcon">💾</div>
                    <div id="saveStatusText">保存中...</div>
                </div>

                <div class="score-display">
                    <div class="score-gauge">
                        <div id="scoreBar" class="score-bar"></div>
                    </div>
                    <div class="score-value">
                        <span id="scoreNumber" class="score-number">0</span>
                        <span class="score-max">/ 100</span>
                    </div>
                    <div id="scoreLabel" class="score-label"></div>
                </div>

                <div class="radar-chart">
                    <canvas id="radarCanvas" width="300" height="300"></canvas>
                </div>

                <div class="final-message">
                    地図（MAP）と指数（JUDGEX²）は渡しました。<br>
                    選ぶのはあなたです。
                </div>
                
                <!-- ログインユーザー向けメッセージ -->
                <div id="historyLinkMessage" class="history-link-message" style="display: none;">
                    <p>💡 この診断結果は自動保存されました</p>
                    <button id="btnViewHistoryFromResult" class="btn-link">
                        📊 履歴を見る
                    </button>
                </div>

                <div class="action-buttons">
                    <button id="btnManualSave" class="btn btn-secondary" style="display: none;">
                        💾 手動保存
                    </button>
                    <button id="btnReset" class="btn btn-secondary">最初から始める</button>
                </div>
            </div>
        </div>

        <!-- STEP 7: 履歴表示 -->
        <div id="step-history" class="step">
            <div class="card history-card">
                <h2>診断履歴</h2>
                
                <div id="historyList" class="history-list">
                    <div class="history-empty">
                        履歴がありません
                    </div>
                </div>
                
                <!-- 成長グラフ -->
                <div id="growthChart" class="growth-chart" style="display: none;">
                    <h3>JUDGEX²スコアの推移</h3>
                    <canvas id="growthCanvas" width="600" height="300"></canvas>
                </div>
                
                <button id="btnCloseHistory" class="btn btn-secondary">閉じる</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>PRE-JUDGE Suite v2.5 | 助言なし、判断は自分で</p>
    </footer>

    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
</body>
</html>
