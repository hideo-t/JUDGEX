# トラブルシューティング & デバッグガイド

## 🐛 よくある問題と解決方法

### 問題0A: Googleログインが失敗する ✨ NEW

#### 症状
- 「Googleでログイン」ボタンをクリック
- エラーメッセージが表示される
- ログインできない

#### 原因と解決策

**ケース1: Firebase設定が完了していない**

**症状:**
- 「Firebase設定が必要です」と表示される
- または「Firebase認証が初期化されていません」と表示

**解決策:**
1. `firebase-config.js` を開く
2. `YOUR_API_KEY` などが残っていないか確認
3. Firebase Consoleから正しい設定をコピー
4. ファイルを保存してリロード

**確認方法:**
```javascript
// firebase-config.js が以下のようになっているか確認
const firebaseConfig = {
    apiKey: "AIzaSy..." // ← 実際の値
    // YOUR_API_KEY のままだとNG
};
```

---

**ケース2: 承認済みドメインに追加されていない**

**症状:**
```
auth/unauthorized-domain
このドメインは承認されていません
```

**解決策:**
1. [Firebase Console](https://console.firebase.google.com/) を開く
2. プロジェクトを選択
3. **Authentication** → **Settings** → **承認済みドメイン**
4. **ドメインを追加** をクリック
5. 使用するドメインを入力
   - ローカル: `localhost`（自動で含まれる）
   - GitHub Pages: `YOUR_USERNAME.github.io`
   - カスタムドメイン: `yourdomain.com`
6. 保存

**重要:** GitHub Pagesの場合、`YOUR_USERNAME.github.io` 全体を追加（サブパスは不要）

---

**ケース3: Google認証が有効になっていない**

**症状:**
- ログインポップアップが開かない
- または「認証方法が無効です」エラー

**解決策:**
1. Firebase Console → **Authentication**
2. **Sign-in method** タブ
3. **Google** をクリック
4. スイッチを**有効**にする
5. サポートメールを選択
6. **保存**

---

**ケース4: ポップアップがブロックされた**

**症状:**
```
auth/popup-blocked
ポップアップがブロックされました
```

**解決策:**
1. ブラウザのアドレスバーの右側にあるアイコンをクリック
2. 「このサイトのポップアップを常に許可」を選択
3. もう一度ログインを試す

**Chrome:**
設定 → プライバシーとセキュリティ → サイトの設定 → ポップアップとリダイレクト

**Firefox:**
設定 → プライバシーとセキュリティ → 許可設定 → ポップアップウィンドウをブロックする

---

**ケース5: ネットワークエラー**

**症状:**
```
auth/network-request-failed
ネットワークエラーが発生しました
```

**解決策:**
1. インターネット接続を確認
2. ファイアウォールの設定を確認
3. VPNを使用している場合は一時的にオフ
4. ブラウザのキャッシュをクリア

---

**ケース6: Firestoreのセキュリティルール**

**症状:**
- ログインは成功するが保存ができない
- 「permission-denied」エラー

**解決策:**
1. Firebase Console → **Firestore Database**
2. **ルール** タブ
3. 以下をコピペ：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

4. **公開** をクリック

---

#### デバッグ方法

**ブラウザのコンソールを確認:**
1. F12キーを押す
2. Console タブを選択
3. ログインボタンをクリック
4. エラーメッセージを確認

**正常な場合のログ:**
```
✅ Firebase初期化完了
プロジェクトID: your-project-id
🔐 Googleログイン開始
ログインポップアップを表示...
✅ ログイン成功: your-email@gmail.com
```

**エラーの場合:**
```
❌ ログインエラー: ...
エラーコード: auth/...
```

エラーコードをメモして、上記のケースと照合してください。

---

### 問題0B: 履歴が保存されない

#### 確認ポイント

1. **ログインモードで開始したか？**
   - ゲストモードでは保存されません
   - 同意画面で「ログインモード」を選択

2. **ログインに成功したか？**
   - 画面右上にメールアドレスが表示されているか確認

3. **Firestoreが有効か？**
   - Firebase Console → Firestore Database
   - データベースが作成されているか確認

4. **セキュリティルールが正しいか？**
   - 上記のケース6を参照

#### コンソールで確認

```
✅ セッション保存成功: session_...
```

このログが出ない場合は保存に失敗しています。

---

### 問題0: フォローアップがループして先に進まない（v2.2で修正済み）

#### 症状
- 「深掘りする」でコメントを入力
- 「もう一度MAPを生成」を押す
- 同じLayer 1の画面に戻ってしまう

#### 原因（v2.1以前）
フォローアップの内容が適切な質問に追加されていなかったため、Layer判定が変わらなかった。

#### 解決策（v2.2で実装済み）
- **Layer 1**: Q2（選択肢）に追加し、決定語を強化
- **Layer 2**: Q3（引き受けるもの）に追加し、責任語を強化
- 自動的にキーワードを補完

#### 確認方法
1. デバッグモード（`?debug=true`）を有効化
2. コンソールログで「現在のLayer」と「新しいLayer」を確認
3. Layer が 1 → 2 または 2 → 3 に変化していることを確認

#### それでもループする場合
フォローアップで以下のキーワードを含めてください：

**Layer 1 → 2への移行:**
- 選ぶ、決める、選択、判断、やる、実行

**Layer 2 → 3への移行:**
- 引き受ける、リスク、責任、代償、覚悟、背負う

---

### 問題1: 「深掘りする」ボタンを押しても次に進まない

#### 解決策A: デバッグモードで確認
URLの末尾に `?debug=true` を追加してアクセスしてください。

例：
```
https://your-username.github.io/pre-judge-suite/?debug=true
```

デバッグ情報（黄色い背景）が表示され、以下が確認できます：
- 現在のLayer
- ボタンの状態

#### 解決策B: ブラウザのコンソールを確認
1. **Chrome/Edge**: `F12` または `Ctrl+Shift+I` (Mac: `Cmd+Option+I`)
2. **Safari**: 開発メニュー → Webインスペクタを表示
3. **Console**タブを開く
4. ボタンをクリック
5. エラーメッセージが表示されていないか確認

正常な場合、以下のようなログが表示されます：
```
Layer 1のボタンを追加しました
深掘りボタンがクリックされました
setupFollowup呼び出し - Layer: 1
step-followupを表示します
showStep呼び出し: step-followup
ステップを表示: step-followup
```

#### 解決策C: キャッシュをクリア
1. ブラウザのキャッシュをクリア
2. ハードリロード (Ctrl+Shift+R / Cmd+Shift+R)
3. もう一度試す

#### 解決策D: 別のブラウザで試す
- Chrome
- Firefox
- Edge
- Safari

いずれかで動作する場合、特定のブラウザの問題です。

---

## 問題2: Layer判定がおかしい

### 確認ポイント
各質問が以下の条件を満たしているか確認：

**Layer 1 → Layer 2への条件:**
- Q2に決定語（選ぶ、決める、転職、買う、別れる、移住、契約など）が含まれている
- 各質問が10文字以上

**Layer 2 → Layer 3への条件:**
- Q3に責任語（引き受ける、失う、責任、代償、リスク、負担、払う、覚悟など）が含まれている
- Q3が20文字以上だとより確実

### テスト入力
Layer 3になる確実な入力例：

**Q1:**
```
営業職から企画職に転職するか迷っている。現在30歳で、今の会社で5年働いているが、新しいことに挑戦したい気持ちと安定を失う不安がある。
```

**Q2:**
```
①今の会社で営業を続ける ②同業他社の企画職に転職する ③異業種の企画職に挑戦する という3つの選択肢がある。
```

**Q3:**
```
転職すると年収が100万円下がる可能性がある。営業の専門性を捨てることになる。失敗したら30代後半で再転職が難しくなる。一方、今のまま続けると新しいスキルが身につかず、将来の選択肢が狭まる。このリスクを引き受ける覚悟が必要。
```

---

## 問題3: JUDGEX²が計測できない

### 原因
Layer 3に到達していない可能性があります。

### 確認方法
MAPで「Layer 3」のバッジが緑色で表示されているか確認。

### 解決策
Q3に「責任語」を追加：
- 引き受ける
- リスク
- 代償
- 負担
- 覚悟
- 犠牲

など

---

## 問題4: GitHubにプッシュしたが404エラー

### 確認ポイント
1. **GitHub Pagesが有効か？**
   - Settings → Pages
   - Source: `main` branch
   - Folder: `/ (root)`

2. **ファイル名が正しいか？**
   - `index.html` (小文字、スペースなし)

3. **URLが正しいか？**
   ```
   https://USERNAME.github.io/REPOSITORY/
   ```
   ※USERNAMEとREPOSITORYは実際の名前に置き換え

4. **デプロイに時間がかかる**
   - 初回は5-10分かかることがある
   - Actions タブで進行状況を確認

---

## 問題5: モバイルでレイアウトが崩れる

### 確認
- 画面を横向きにする
- ズームレベルを調整 (ピンチイン/アウト)

### 既知の問題
一部の古いブラウザではCSS Grid未対応の可能性があります。

---

## 開発者向けデバッグ

### ローカルで確認
```bash
# 簡易HTTPサーバーを起動 (Python)
python -m http.server 8000

# ブラウザで開く
# http://localhost:8000
```

### コンソールログを有効化
app.jsの各関数に `console.log()` が既に追加されています。

### ブレークポイント
Chrome DevToolsで以下にブレークポイントを設定：
- `setupFollowup()`
- `showStep()`
- `displayMap()`

---

## それでも解決しない場合

### 報告してください
GitHubのIssuesで以下の情報と共に報告：

1. 問題の詳細
2. 使用ブラウザとバージョン
3. スクリーンショット
4. コンソールのエラーメッセージ（あれば）

---

**PRE-JUDGE Suite** - トラブルシューティング
